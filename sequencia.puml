@startuml Sequence_YouTubeDownloader
!theme amiga

title Sequência de Download - YouTube Downloader

actor "Usuário" as User
participant "Interface\n(React)" as UI
participant "useDownloadManager\n(Hook)" as Hook
participant "WebSocket\nClient" as WS
participant "FastAPI\nBackend" as API
participant "WebSocket\nManager" as WSM
participant "pytubefix\n+ MoviePy" as Engine
participant "YouTube" as YT

== Inicialização ==
User -> UI: Acessa localhost:5173
UI -> Hook: Carrega gerenciador
Hook -> WS: Conecta ws://localhost:8000/ws
WS -> WSM: accept()
WSM -> Hook: Conexão estabelecida

== Pesquisa de Vídeos ==
User -> UI: Digite termo de busca
UI -> Hook: searchVideos(term)
Hook -> API: GET /search?term=...
API -> YT: YouTube Data API v3
YT -> API: Resultados JSON
API -> Hook: Lista com thumbnails
Hook -> UI: Exibe vídeos encontrados
UI -> User: Mostra resultados

== Seleção de Tipo de Mídia ==
User -> UI: Escolhe Áudio ou Vídeo
UI -> Hook: setMediaType("audio"|"video")
Hook -> UI: Atualiza interface

== Seleção de Conteúdo ==
User -> UI: Clica em vídeo
UI -> Hook: selectItem(videoData)

alt Item Único
    Hook -> Hook: Verifica lista vazia
    UI -> Hook: startDownload([videoData], mediaType)
    note right: Download imediato
    
else Múltiplos Itens
    Hook -> Hook: addToDownloadList(videoData)
    Hook -> UI: Atualiza contador lista
    UI -> User: Mostra "X itens na lista"
    User -> UI: Clica "Baixar Lista"
    UI -> Hook: startDownload(downloadList, mediaType)
end

== Processamento Backend ==
Hook -> API: POST /download/\n{urls, format: mediaType}
API -> Engine: Valida URLs
Engine -> YT: Extrai informações
YT -> Engine: Metadados do vídeo

alt URLs Válidas
    API -> WSM: notify("download_started")
    WSM -> WS: Broadcast message
    WS -> Hook: Atualiza estado
    Hook -> UI: Mostra "Download iniciado"
    
    == Download e Conversão ==
    loop Para cada vídeo
        Engine -> YT: Download stream
        YT -> Engine: Dados do vídeo
        
        alt mediaType == "audio"
            Engine -> Engine: MoviePy extrai áudio
            Engine -> Engine: Converte para MP3
            API -> WSM: notify("conversion_progress", 60%)
            Engine -> Engine: Remove arquivo original
        else mediaType == "video" 
            note right: Mantém MP4 original
            API -> WSM: notify("download_progress", 90%)
        end
        
        WSM -> WS: Progress update
        WS -> Hook: Atualiza progresso
        Hook -> UI: Barra de progresso
    end
    
    == Finalização ==
    alt Lista com 2+ itens
        API -> Engine: create_zip_from_files()
        Engine -> API: arquivo.zip
        note right: ZIP automático para lotes
    end
    
    API -> WSM: notify("download_complete", file_path)
    WSM -> WS: Download completo
    WS -> Hook: Arquivo pronto
    Hook -> UI: Inicia download browser
    UI -> User: Arquivo baixado
    
    == Limpeza Automática ==
    WSM -> WSM: schedule_file_cleanup(30s)
    note right: Task assíncrona
    
    WSM -> WSM: sleep(30)
    WSM -> API: Remove arquivo
    WSM -> WS: notify("file_cleaned")
    WS -> Hook: Arquivo removido
    
else URLs Inválidas
    API -> WSM: notify("download_error")
    WSM -> WS: Erro
    WS -> Hook: Mostra erro
    Hook -> UI: Mensagem de erro
    UI -> User: "URLs inválidas"
end

@enduml